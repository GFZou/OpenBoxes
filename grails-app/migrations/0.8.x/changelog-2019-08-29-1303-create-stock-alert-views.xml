<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

  <changeSet author="jmiranda (generated)" id="1567101942662-1" runOnChange="true"
    failOnError="false">
    <createView viewName="product_inventory_snapshot_view" replaceIfExists="true">
      <![CDATA[
        SELECT
          inventory_snapshot.product_id AS product_id,
          inventory_snapshot.location_id AS location_id,
          inventory_snapshot.date AS date,
        SUM(inventory_snapshot.quantity_on_hand) AS quantity_on_hand
        FROM inventory_snapshot
        WHERE date BETWEEN timestamp(current_date) AND timestamp(current_date+1)
        GROUP BY date, location_id, product_id
      ]]>
    </createView>
  </changeSet>
  <changeSet author="jmiranda (generated)" id="1567101942662-2" runOnChange="true"
    failOnError="false">
    <createView viewName="product_inventory_extended_view" replaceIfExists="true">
      <![CDATA[
        SELECT
          product_inventory_snapshot_view.product_id AS product_id,
          product_inventory_snapshot_view.location_id AS location_id,
          product_inventory_snapshot_view.date AS date,
        CASE WHEN date = timestamp(current_date) THEN quantity_on_hand END AS yesterday,
        CASE WHEN date = timestamp(current_date+1) THEN quantity_on_hand END AS today
        FROM product_inventory_snapshot_view
      ]]>
    </createView>
  </changeSet>
  <changeSet author="jmiranda (generated)" id="1567101942662-3" runOnChange="true"
    failOnError="false">
    <createView viewName="product_inventory_pivot_view" replaceIfExists="true">
      <![CDATA[
        SELECT
          product_id,
          location_id,
          sum(yesterday) AS yesterday,
          sum(today) AS today
        FROM product_inventory_extended_view
        GROUP BY product_id, location_id
      ]]>
    </createView>
  </changeSet>
  <changeSet author="jmiranda (generated)" id="1567101942662-4" runOnChange="true"
    failOnError="false">
    <createView viewName="product_inventory_compare_view" replaceIfExists="true">
      <![CDATA[
        SELECT
          product_inventory_pivot_view.*,
          (yesterday != today) as changed,
          COALESCE(inventory_level.min_quantity, 0) AS min_quantity,
          COALESCE(inventory_level.reorder_quantity, 0) AS reorder_quantity,
          COALESCE(inventory_level.max_quantity, 0) AS max_quantity
        FROM product_inventory_pivot_view
        JOIN product on product.id = product_inventory_pivot_view.product_id
        JOIN location on location.id = product_inventory_pivot_view.location_id
        LEFT JOIN inventory_level on (inventory_level.product_id = product.id
          AND inventory_level.inventory_id = location.inventory_id)
      ]]>
    </createView>
  </changeSet>
  <changeSet author="jmiranda (generated)" id="1567101942662-5" runOnChange="true"
    failOnError="false">
    <createView viewName="product_inventory_expiry_view" replaceIfExists="true">
      <![CDATA[
        SELECT
          location.id AS facility_id,
          location.name AS facility_name,
          bin.id AS bin_id,
          bin.name AS bin_name,
          product.id AS product_id,
          product.product_code AS product_code,
          inventory_item.id AS inventory_item_id,
          inventory_item.lot_number AS lot_number,
          inventory_item.expiration_date AS expiration_date,
          datediff(inventory_item.expiration_date, now()) as days_until_expiry,
          quantity_on_hand
        FROM inventory_snapshot
        JOIN location on inventory_snapshot.location_id = location.id
        LEFT JOIN location bin on inventory_snapshot.bin_location_id = bin.id
        JOIN inventory_item on inventory_item.id = inventory_snapshot.inventory_item_id
        JOIN product on inventory_item.product_id = product.id
        WHERE date = (select max(date) from inventory_snapshot);
      ]]>
    </createView>
  </changeSet>
  <changeSet author="jmiranda (generated)" id="1567101942662-6" runOnChange="true"
    failOnError="false">
    <createView viewName="product_inventory_extended_expiry_view" replaceIfExists="true">
      <![CDATA[
        select
          *,
          CASE WHEN days_until_expiry < 365 then true else false end as under_365,
          CASE WHEN days_until_expiry < 180 then true else false end as under_180,
          CASE WHEN days_until_expiry < 90 then true else false end as under_90,
          CASE WHEN days_until_expiry < 60 then true else false end as under_60,
          CASE WHEN days_until_expiry < 30 then true else false end as under_30,
          CASE WHEN days_until_expiry < 14 then true else false end as under_14,
          CASE WHEN days_until_expiry < 7 then true else false end as under_7,
          CASE WHEN days_until_expiry <= 0 then true else false end as expired
        FROM product_inventory_expiry_view
      ]]>
    </createView>
  </changeSet>
</databaseChangeLog>
